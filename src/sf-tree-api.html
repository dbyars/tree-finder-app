<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="sf-tree-api">

  <template>

    <iron-ajax auto url="[[_requestUrl]]" handle-as="json" last-response="{{response}}" on-response="handleResponse"></iron-ajax>

  </template>

  <script>
    Polymer({
      is: 'sf-tree-api',
      properties: {
        _baseUrl: {
          type: String,
          value: 'https://data.sfgov.org/resource/2zah-tuvt.json?'
        },
        queryParams: {
          type: String,
          value: "$limit=1000&$where=latitude between 37.709864 and 37.781918 AND longitude between -122.501212 and -122.39894"
        },
        data: {
          type: Array,
          readOnly: true,
          notify: true,
          value: function() {
            return []
          }
        },
        _requestUrl: {
          type: String,
          computed: '_computeUrl(_baseUrl, queryParams)',
        }
      },
      _computeUrl: function(baseUrl, queryParams) {
        var params = baseUrl + queryParams
        console.log('SF Tree Api Query String: ' + params)

        return baseUrl + queryParams
      },
      handleResponse: function() {
        var newData = []

        this.response.map(function(item) {
          newData.push({
            latitude: item.latitude,
            longitude: item.longitude,
            species: item.qspecies.split('::')[0].trim(),
            commonName: item.qspecies.split('::')[1].trim()
          })
        })

        this._setData(newData)
      }
    });
  </script>
</dom-module>
